---
layout: default
---
<article class="post">
  <h1>{{ page.title }}</h1>
  <time datetime="{{ page.date | date_to_xmlschema }}">{{ page.date | date: "%B %d, %Y" }}</time>
  <div class="content">
    {{ content }}
  </div>
</article>

<section class="comments">
  <h2>Comments</h2>
  <div id="comments-container">Loading comments...</div>
  <form id="comment-form">
    <input type="text" id="comment-name" placeholder="Your name" required>
    <textarea id="comment-text" placeholder="Your comment" required></textarea>
    <button type="submit">Post Comment</button>
  </form>
</section>

<script>
const SUPABASE_URL = 'https://lrizdpqgyhmrpvcjhhgh.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxyaXpkcHFneWhtcnB2Y2poaGdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExMTAwNTUsImV4cCI6MjA4NjY4NjA1NX0.AbjPVP3BYXlIs4VHDhaSTZ1SiGWTgcEBk41F0sFijEQ';
const POST_ID = '{{ page.id }}';

async function loadComments() {
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/comments?post_id=eq.${POST_ID}&select=*`, {
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`
      }
    });
    const comments = await res.json();
    const container = document.getElementById('comments-container');
    if (comments.length === 0) {
      container.innerHTML = '<p>No comments yet. Be the first!</p>';
    } else {
      container.innerHTML = comments.map(c => `
        <div class="comment">
          <strong>${escapeHtml(c.author_name)}</strong>
          <small>${new Date(c.created_at).toLocaleDateString()}</small>
          <p>${escapeHtml(c.content)}</p>
        </div>
      `).join('');
    }
  } catch (e) {
    document.getElementById('comments-container').innerHTML = '<p>Unable to load comments. Try again later.</p>';
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

document.getElementById('comment-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const name = document.getElementById('comment-name').value;
  const text = document.getElementById('comment-text').value;
  
  try {
    await fetch(`${SUPABASE_URL}/rest/v1/comments`, {
      method: 'POST',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': 'return=minimal'
      },
      body: JSON.stringify({ post_id: POST_ID, author_name: name, content: text })
    });
    document.getElementById('comment-form').reset();
    loadComments();
  } catch (e) {
    alert('Failed to post comment. Try again later.');
  }
});

loadComments();
</script>
